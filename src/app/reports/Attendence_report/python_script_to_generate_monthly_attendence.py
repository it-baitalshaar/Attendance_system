import pandas as pd
import psycopg2
from openpyxl import load_workbook


# Database connection parameters
host = 'aws-0-ap-south-1.pooler.supabase.com'
port = 6543
dbname = 'postgres'
user = 'postgres.fhsvgeacwnnvqidyhnok'
password = 'Bait-Alshaar20'

file_path = r"C:\Users\IT\OneDrive\Desktop\Attendance_system\src\app\reports\jan_report_2026_new.xlsx"
workbook = load_workbook(file_path)

template_sheet = workbook['Sheet1']


# Connect to the database
try:
    connection = psycopg2.connect(
        host=host,
        port=port,
        dbname=dbname,
        user=user,
        password=password
    )
    cursor = connection.cursor()
    print("Connected to the database!")

    query = '''
        SELECT 
            e.employee_id,
            e.name,
            e.salary,
            a.date,
            a.notes,
            a.status,
            a.status_attendance,
            p.project_name,
            ap.working_hours,
            ap.overtime_hours
        FROM 
            "Employee" e
        LEFT JOIN 
            "Attendance" a ON e.employee_id = a.employee_id
        LEFT JOIN
            "Attendance_projects" ap ON a.id = ap.attendance_id
        LEFT JOIN
            projects p ON ap.project_id = p.project_id
        WHERE 
            a.date BETWEEN '2026-01-01' AND '2026-01-31'
        ORDER BY 
            e.employee_id, a.date;
    '''

    cursor.execute(query)
    data = cursor.fetchall()

    df = pd.DataFrame(data, columns=[
        'employee_id', 'name', 'salary', 'date', 'notes', 'status',
        'status_attendance', 'project_name', 'working_hours', 'overtime_hours'
    ])

    grouped_data = df.groupby('employee_id')

    for employee_id, employee_data in grouped_data:
        employee_sheet = workbook.copy_worksheet(template_sheet)

        first_row = employee_data.iloc[0]
        employee_sheet['B4'] = first_row['name']
        employee_sheet.title = f"{first_row['name']}"
        employee_sheet.sheet_view.rightToLeft = template_sheet.sheet_view.rightToLeft
        employee_sheet[f'I{2}'] = first_row['salary']

        row_date = 7  # Start from row 7

        # --- KEY FIX: Group by date so each day = exactly one row ---
        daily_grouped = employee_data.groupby('date')

        for date_value, day_data in daily_grouped:
            # These values are the same for all rows of the same day
            status = day_data.iloc[0]['status']
            status_attendance = day_data.iloc[0]['status_attendance']
            notes = day_data.iloc[0]['notes']

            # --- Write the date ---
            employee_sheet[f'A{row_date}'] = date_value

            # --- Write notes ---
            employee_sheet[f'J{row_date}'] = notes

            # --- Write attendance status code ---
            if status == 'present' and status_attendance == 'Present':
                employee_sheet[f'B{row_date}'] = 'P'
            elif status == 'present' and status_attendance == 'Weekend':
                employee_sheet[f'B{row_date}'] = 'W'
            elif status == 'present' and status_attendance == 'Holiday-Work':
                employee_sheet[f'B{row_date}'] = 'H'
            elif status == 'absent' and status_attendance == 'Absence without excuse':
                employee_sheet[f'B{row_date}'] = 'AWO'
            elif status == 'absent' and status_attendance == 'Sick Leave':
                employee_sheet[f'B{row_date}'] = 'SL'
            elif status == 'absent' and status_attendance == 'Absence with excuse':
                employee_sheet[f'B{row_date}'] = 'A'
            elif status == 'vacation':
                employee_sheet[f'B{row_date}'] = 'V'

            # --- Sum total working hours for the day ---
            total_working_hours = day_data['working_hours'].sum()

            # If working hours are all 0 but it's Weekend or Holiday-Work, default to 8
            if total_working_hours == 0:
                if status_attendance in ('Weekend', 'Holiday-Work'):
                    total_working_hours = 8

            if total_working_hours != 0:
                employee_sheet[f'C{row_date}'] = total_working_hours

            # --- Sum overtime hours per type (Present / Weekend / Holiday-Work) ---
            total_overtime = day_data['overtime_hours'].sum()

            if total_overtime != 0:
                if status_attendance == 'Present':
                    employee_sheet[f'D{row_date}'] = total_overtime
                elif status_attendance == 'Weekend':
                    employee_sheet[f'E{row_date}'] = total_overtime
                elif status_attendance == 'Holiday-Work':
                    employee_sheet[f'F{row_date}'] = total_overtime

            # --- Build the combined project string ---
            # Example output: "Home's Mr.Abdullah 3hrs + Saqia 20 5hrs"
            if len(day_data) == 1:
                # Single project — just write the project name
                project_text = day_data.iloc[0]['project_name']
            else:
                # Multiple projects — combine with hours
                project_parts = []
                for _, proj_row in day_data.iterrows():
                    proj_name = proj_row['project_name'] if proj_row['project_name'] else 'Unknown'
                    proj_hours = int(proj_row['working_hours']) if proj_row['working_hours'] != 0 else 0
                    project_parts.append(f"{proj_name} {proj_hours}hrs")
                project_text = " + ".join(project_parts)

            employee_sheet[f'H{row_date}'] = project_text

            # Move to next row
            row_date += 1

        print(f"Data written for Employee ID: {employee_id} — {first_row['name']}")

    workbook.save(file_path)
    print("Excel file updated successfully — no extra rows inserted!")

except Exception as error:
    print(f"Error: {error}")

finally:
    if connection:
        cursor.close()
        connection.close()
        print("Database connection closed.")